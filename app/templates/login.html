<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - GreenCredit AI</title>
    <link rel="icon" type="image/svg+xml" href="/static/img/logo.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl border border-slate-100 p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <div
                class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-emerald-100 text-emerald-600 mb-4">
                <i class="fas fa-leaf text-xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-800">GreenCredit AI</h1>
            <p class="text-slate-500 text-sm mt-2">绿色信贷智能助手</p>
        </div>

        <!-- Tabs -->
        <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
            <button onclick="switchTab('login')" id="tab-login"
                class="flex-1 py-2 text-sm font-medium rounded-lg bg-white text-slate-800 shadow-sm transition-all">登录</button>
            <button onclick="switchTab('register')" id="tab-register"
                class="flex-1 py-2 text-sm font-medium rounded-lg text-slate-500 hover:text-slate-700 transition-all">注册</button>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
            <div>
                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">用户名</label>
                <input type="text" name="username" required
                    class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all"
                    placeholder="输入用户名">
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">密码</label>
                <input type="password" name="password" required
                    class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all"
                    placeholder="输入密码">
            </div>
            <button type="submit"
                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 rounded-lg transition-all shadow-lg shadow-emerald-200">
                <span id="login-btn-text">立即登录</span>
                <i id="login-btn-icon" class="fas fa-arrow-right ml-2"></i>
            </button>
        </form>

        <!-- Register Form (Hidden) -->
        <form id="register-form" class="space-y-4 hidden" onsubmit="handleRegister(event)">
            <div>
                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">用户名</label>
                <input type="text" name="username" required
                    class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all"
                    placeholder="设置用户名">
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">密码</label>
                <input type="password" name="password" required
                    class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all"
                    placeholder="设置密码">
            </div>
            <button type="submit"
                class="w-full bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 rounded-lg transition-all shadow-lg">
                <span id="reg-btn-text">创建账号</span>
            </button>
        </form>

        <div id="error-msg" class="mt-4 text-center text-xs text-red-500 hidden"></div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300"
            id="success-modal-content">
            <div class="text-center">
                <div
                    class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    <i class="fas fa-check"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">注册成功!</h3>
                <p class="text-slate-500 text-sm mb-6">您的账号已成功创建，现在可以使用新账号登录系统了。</p>
                <button onclick="closeSuccessModal()"
                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 rounded-lg transition-all shadow-lg shadow-emerald-200">
                    立即登录
                </button>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            const errorMsg = document.getElementById('error-msg');

            errorMsg.classList.add('hidden');

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabLogin.className = "flex-1 py-2 text-sm font-medium rounded-lg bg-white text-slate-800 shadow-sm transition-all";
                tabRegister.className = "flex-1 py-2 text-sm font-medium rounded-lg text-slate-500 hover:text-slate-700 transition-all";
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabRegister.className = "flex-1 py-2 text-sm font-medium rounded-lg bg-white text-slate-800 shadow-sm transition-all";
                tabLogin.className = "flex-1 py-2 text-sm font-medium rounded-lg text-slate-500 hover:text-slate-700 transition-all";
            }
        }

        // Modal Logic
        function showSuccessModal() {
            const modal = document.getElementById('success-modal');
            const content = document.getElementById('success-modal-content');
            modal.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeSuccessModal() {
            const modal = document.getElementById('success-modal');
            const content = document.getElementById('success-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                switchTab('login');
            }, 300);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const btnText = document.getElementById('login-btn-text');
            const errorMsg = document.getElementById('error-msg');

            btnText.innerText = "登录中...";
            errorMsg.classList.add('hidden');

            try {
                const res = await fetch('/api/v1/auth/token', {
                    method: 'POST',
                    body: formData // OAuth2PasswordRequestForm accepts FormData
                });

                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('access_token', data.access_token);
                    // Fetch user info to store basic profile
                    const meRes = await fetch('/api/v1/auth/users/me', {
                        headers: { 'Authorization': `Bearer ${data.access_token}` }
                    });
                    if (meRes.ok) {
                        const meData = await meRes.json();
                        // Update app settings profile
                        const settings = JSON.parse(localStorage.getItem('app_settings') || '{}');
                        if (!settings.userProfile) settings.userProfile = {};
                        settings.userProfile.name = meData.username;
                        settings.userProfile.id = meData.id;
                        localStorage.setItem('app_settings', JSON.stringify(settings));
                    }
                    window.location.href = '/';
                } else {
                    const err = await res.json();
                    throw new Error(err.detail || '登录失败');
                }
            } catch (err) {
                errorMsg.innerText = err.message;
                errorMsg.classList.remove('hidden');
            } finally {
                btnText.innerText = "立即登录";
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form));
            const btnText = document.getElementById('reg-btn-text');
            const errorMsg = document.getElementById('error-msg');

            // Frontend Validation
            if (!data.username || data.username.length < 3) {
                errorMsg.innerText = "用户名长度至少需要 3 个字符";
                errorMsg.classList.remove('hidden');
                return;
            }
            if (!data.password || data.password.length < 8) {
                errorMsg.innerText = "密码长度至少需要 8 个字符";
                errorMsg.classList.remove('hidden');
                return;
            }

            btnText.innerText = "注册中...";
            errorMsg.classList.add('hidden');

            try {
                const res = await fetch('/api/v1/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    form.reset();
                    showSuccessModal();
                } else {
                    const err = await res.json();
                    throw new Error(err.detail || '注册失败');
                }
            } catch (err) {
                errorMsg.innerText = err.message;
                errorMsg.classList.remove('hidden');
            } finally {
                btnText.innerText = "创建账号";
            }
        }
    </script>
</body>

</html>